<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最寄り駅検索アプリ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent body scroll */
        }
        h1 {
            text-align: center;
            font-size: 1.2em;
            margin: 10px 0;
            flex-shrink: 0;
        }
        #controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 15px 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            background: #fff;
            flex-shrink: 0;
            flex-wrap: wrap;
        }
        #address-container {
            display: flex;
            flex-grow: 1; /* Makes the input field take up available space */
        }
        #address-input {
            flex-grow: 1;
            min-width: 150px;
            padding: 8px;
            border: 1px solid #ccc;
            border-right: none;
            border-radius: 4px 0 0 4px;
        }
        #controls button, #controls select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            white-space: nowrap; /* Prevent button text from wrapping */
        }
        #current-location-btn {
            border-radius: 0 4px 4px 0;
        }
        #search-btn {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        #search-btn:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }

        #map-container {
            flex-grow: 1;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #result {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 450px;
            overflow: hidden;
            display: none;
        }
        #result-header {
            padding: 8px;
            cursor: move;
            background-color: #f1f1f1;
            border-bottom: 1px solid #ccc;
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
        }
        #result-table-container {
            overflow-y: auto;
        }
        @media (max-width: 768px) {
            #controls {
                justify-content: center;
            }
            #address-container {
                width: 100%;
                order: 1; /* Full width input first */
            }
            #controls label, #controls select, #controls button {
                order: 2; /* Then the rest of controls */
            }
            #result {
                top: auto;
                bottom: 10px;
                right: 10px;
                left: 10px;
                width: auto;
            }
            #result-table-container {
                max-height: 200px;
            }
        }
        #spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10001;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #result table {
            width: 100%;
            border-collapse: collapse;
        }
        #result th, #result td {
            border-bottom: 1px solid #ddd;
            padding: 6px;
            text-align: left;
            font-size: 0.85em;
        }
        #result th {
            background-color: #f2f2f2;
            text-align: center;
            position: sticky;
            top: 0;
        }
        .leaflet-div-icon {
            background: #3498db;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            line-height: 26px;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>最寄り駅検索</h1>
    <div id="controls">
        <div id="address-container">
            <input type="text" id="address-input" placeholder="住所や地名を入力、または地図をクリック...">
            <button id="current-location-btn" class="btn-secondary">現在地</button>
        </div>
        <input type="hidden" id="lat-input">
        <input type="hidden" id="lng-input">
        <label for="limit-select">表示件数:</label>
        <select id="limit-select">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
        </select>
        <button id="reset-btn" class="btn-danger">リセット</button>
        <button id="search-btn">検索</button>
    </div>

    <div id="map-container">
        <div id="map"></div>
        <div id="result">
             <div id="result-header">最寄り駅一覧</div>
             <div id="result-table-container"></div>
        </div>
    </div>

    <div id="spinner-overlay">
        <div class="spinner"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 初期設定 ---
        const map = L.map('map').setView([35.6812, 139.7671], 13);
        let searchMarker;
        let stationMarkers = [];
        const lambdaUrl = "https://lmk2n4gjvur5ojmdugvwqboati0ycwvc.lambda-url.ap-northeast-1.on.aws/";

        const resultDiv = document.getElementById('result');
        const resultTableContainer = document.getElementById('result-table-container');

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const spinnerOverlay = document.getElementById('spinner-overlay');
        function showSpinner() { spinnerOverlay.style.display = 'flex'; }
        function hideSpinner() { spinnerOverlay.style.display = 'none'; }

        map.on('click', (e) => updateSearchLocation(e.latlng.lat, e.latlng.lng));
        document.getElementById('current-location-btn').addEventListener('click', useCurrentLocation);
        document.getElementById('search-btn').addEventListener('click', executeSearch);
        document.getElementById('reset-btn').addEventListener('click', resetMap);


        window.addEventListener('resize', () => { setTimeout(() => { map.invalidateSize() }, 100); });

        dragElement(document.getElementById('result'));

        // --- 機能関数 ---

        function clearMarkers() {
            if (searchMarker) {
                map.removeLayer(searchMarker);
                searchMarker = null;
            }
            stationMarkers.forEach(m => map.removeLayer(m));
            stationMarkers = [];
        }

        function resetMap() {
            clearMarkers();
            document.getElementById('address-input').value = '';
            document.getElementById('lat-input').value = '';
            document.getElementById('lng-input').value = '';
            resultTableContainer.innerHTML = '';
            resultDiv.style.display = 'none';
            map.setView([35.6812, 139.7671], 13);
        }

        async function updateSearchLocation(lat, lng) {
            showSpinner();
            clearMarkers(); // Clear previous markers
            searchMarker = L.marker([lat, lng]).addTo(map);
            map.setView([lat, lng], 15);

            document.getElementById('lat-input').value = lat;
            document.getElementById('lng-input').value = lng;
            document.getElementById('address-input').value = "住所を検索中...";
            resultDiv.style.display = 'none';

            try {
                await reverseGeocode(lat, lng);
            } finally {
                hideSpinner();
            }
        }

        function useCurrentLocation() {
            if ('geolocation' in navigator) {
                showSpinner();
                navigator.geolocation.getCurrentPosition(async position => {
                    await updateSearchLocation(position.coords.latitude, position.coords.longitude);
                }, error => {
                    console.error("Geolocation Error:", error);
                    alert("現在地を取得できませんでした。");
                    hideSpinner();
                });
            } else {
                alert("お使いのブラウザは位置情報機能に対応していません。");
            }
        }

        async function executeSearch() {
            let lat = document.getElementById('lat-input').value;
            let lng = document.getElementById('lng-input').value;
            const address = document.getElementById('address-input').value;

            showSpinner();
            // Clear previous results immediately for better UX
            clearMarkers();
            resultTableContainer.innerHTML = '';
            resultDiv.style.display = 'none';

            // Geocode if address is provided but lat/lng are missing
            if ((!lat || !lng) && address) {
                 try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`, {
                        headers: { 'User-Agent': 'NearestStationApp/1.0' }
                    });
                    const data = await response.json();
                    if (data && data.length > 0) {
                        lat = parseFloat(data[0].lat);
                        lng = parseFloat(data[0].lon);
                        document.getElementById('lat-input').value = lat;
                        document.getElementById('lng-input').value = lng;
                        // Add a new search marker
                        searchMarker = L.marker([lat, lng]).addTo(map);
                        map.setView([lat, lng], 15);
                    } else {
                        alert("住所が見つかりませんでした。");
                        hideSpinner();
                        return;
                    }
                } catch(error) {
                    console.error("Address Search Error:", error);
                    alert("住所の検索中にエラーが発生しました。");
                    hideSpinner();
                    return;
                }
            } else if (!lat || !lng) {
                 alert("住所を入力するか、地図をクリックしてください。");
                 hideSpinner();
                 return;
            }

            await searchFromCoordinates(lat, lng);
        }

        async function searchFromCoordinates(lat, lng) {
            try {
                const limit = document.getElementById('limit-select').value;
                const url = `${lambdaUrl}?lat=${lat}&lng=${lng}&limit=${limit}`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`API returned status: ${response.status}`);
                }
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                console.error("Fetch Error:", error);
                alert("最寄り駅の検索中にエラーが発生しました。");
            } finally {
                hideSpinner();
            }
        }

        function displayResults(data) {
            if (data.error || !data.response || !data.response.station || data.response.station.length === 0) {
                alert(data.error || "駅が見つかりませんでした。");
                return;
            }

            const stationsToDisplay = data.response.station;
            const table = document.createElement('table');
            const thead = table.createTHead();
            const tbody = table.createTBody();
            const headerRow = thead.insertRow();
            ['順', '駅名', '路線', '距離(km)'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            stationsToDisplay.forEach((s, index) => {
                const rank = index + 1;
                if(s.lat && s.lon) {
                    const numberIcon = L.divIcon({
                        className: 'leaflet-div-icon',
                        html: `<span>${rank}</span>`,
                        iconSize: [28, 28]
                    });
                    const marker = L.marker([s.lat, s.lon], { icon: numberIcon })
                        .addTo(map)
                        .bindPopup(`<b>${rank}. ${s.name}駅</b><br>${s.line || ''}`);
                    stationMarkers.push(marker); // IMPORTANT: Track marker for removal
                }
                const row = tbody.insertRow();
                row.insertCell().textContent = rank;
                row.insertCell().textContent = s.name;
                row.insertCell().textContent = s.line || '---';
                row.insertCell().textContent = (parseFloat(s.distance) / 1000).toFixed(2);
            });

            resultTableContainer.innerHTML = ''; // Clear previous table
            resultTableContainer.appendChild(table);
            resultDiv.style.display = 'block';
        }

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`, {
                     headers: { 'User-Agent': 'NearestStationApp/1.0' }
                });
                const data = await response.json();
                document.getElementById('address-input').value = (data && data.display_name) ? data.display_name : `緯度: ${lat.toFixed(6)}, 経度: ${lng.toFixed(6)}`;
            } catch(error) {
                console.error("Reverse Geocode Error:", error);
                document.getElementById('address-input').value = `緯度: ${lat.toFixed(6)}, 経度: ${lng.toFixed(6)}`;
            }
        }

        function dragElement(elmnt) {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const header = document.getElementById("result-header");

            if (header) {
                header.onmousedown = dragMouseDown;
            } else {
                elmnt.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
    </script>
</body>
</html>
