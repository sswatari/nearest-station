<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最寄り駅検索アプリ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
        }
        h1 {
            text-align: center;
            font-size: 1.2em;
            margin: 10px 0;
            flex-shrink: 0; /* Prevent h1 from shrinking */
        }
        #controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 0 15px 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            background: #fff;
            flex-shrink: 0; /* Prevent controls from shrinking */
        }
        #address-input {
            width: 250px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #controls button, #controls select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
        }
        #controls button {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        #controls button:hover {
            background-color: #0056b3;
        }

        #map-container {
            flex-grow: 1; /* Take up remaining vertical space */
            position: relative; /* Anchor for absolute children */
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #result {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-height: 40vh; /* Max height to prevent taking over screen */
            max-width: 450px;
            overflow: auto;
            display: none; /* Initially hidden */
        }

        /* Responsive layout for mobile */
        @media (max-width: 768px) {
            #result {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* Spinner Styles */
        #spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Table and Icon Styles */
        #result table {
            width: 100%;
            border-collapse: collapse;
        }
        #result th, #result td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
            font-size: 0.85em;
        }
        #result th {
            background-color: #f2f2f2;
            text-align: center;
            position: sticky;
            top: 0;
        }
        .leaflet-div-icon {
            background: #3498db;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            line-height: 26px;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>最寄り駅検索</h1>
    <div id="controls">
        <input type="text" id="address-input" placeholder="住所や地名を入力、または地図をクリック...">
        <input type="hidden" id="lat-input">
        <input type="hidden" id="lng-input">
        <button id="current-location-btn">現在地を利用</button>
        <button id="search-btn">検索</button>
        <label for="limit-select">表示件数:</label>
        <select id="limit-select">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
        </select>
    </div>
    
    <div id="map-container">
        <div id="map"></div>
        <div id="result"></div>
    </div>

    <div id="spinner-overlay">
        <div class="spinner"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 初期設定 ---
        const map = L.map('map').setView([35.6812, 139.7671], 13);
        let searchMarker;
        let stationMarkers = [];
        const lambdaUrl = "https://lmk2n4gjvur5ojmdugvwqboati0ycwvc.lambda-url.ap-northeast-1.on.aws/";

        const addressInput = document.getElementById('address-input');
        const latInput = document.getElementById('lat-input');
        const lngInput = document.getElementById('lng-input');
        const resultDiv = document.getElementById('result');

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        const spinnerOverlay = document.getElementById('spinner-overlay');
        function showSpinner() { spinnerOverlay.style.display = 'flex'; }
        function hideSpinner() { spinnerOverlay.style.display = 'none'; }

        map.on('click', (e) => updateSearchLocation(e.latlng.lat, e.latlng.lng));
        document.getElementById('current-location-btn').addEventListener('click', useCurrentLocation);
        document.getElementById('search-btn').addEventListener('click', executeSearch);
        
        // Invalidate map size on window resize to fix rendering issues
        window.addEventListener('resize', () => {
            setTimeout(() => { map.invalidateSize() }, 100);
        });

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`, {
                     headers: { 'User-Agent': 'NearestStationApp/1.0' }
                });
                const data = await response.json();
                addressInput.value = (data && data.display_name) ? data.display_name : `緯度: ${lat.toFixed(6)}, 経度: ${lng.toFixed(6)}`;
            } catch(error) {
                console.error("Reverse Geocode Error:", error);
                addressInput.value = `緯度: ${lat.toFixed(6)}, 経度: ${lng.toFixed(6)}`;
            }
        }
        
        async function updateSearchLocation(lat, lng) {
            showSpinner();
            if (searchMarker) map.removeLayer(searchMarker);
            searchMarker = L.marker([lat, lng]).addTo(map);
            map.setView([lat, lng], 15);
            
            latInput.value = lat;
            lngInput.value = lng;
            
            addressInput.value = "住所を検索中...";
            resultDiv.style.display = 'none'; // Hide old results
            await reverseGeocode(lat, lng);
            hideSpinner();
        }

        function useCurrentLocation() {
            if ('geolocation' in navigator) {
                showSpinner();
                navigator.geolocation.getCurrentPosition(async position => {
                    await updateSearchLocation(position.coords.latitude, position.coords.longitude);
                }, error => {
                    console.error("Geolocation Error:", error);
                    alert("現在地を取得できませんでした。");
                    hideSpinner();
                });
            } else {
                alert("お使いのブラウザは位置情報機能に対応していません。");
            }
        }
        
        async function executeSearch() {
            let lat = latInput.value;
            let lng = lngInput.value;
            const address = addressInput.value;
            
            showSpinner();
            resultDiv.style.display = 'none';

            if ((!lat || !lng) && address) {
                 try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`, {
                        headers: { 'User-Agent': 'NearestStationApp/1.0' }
                    });
                    const data = await response.json();
                    if (data && data.length > 0) {
                        lat = parseFloat(data[0].lat);
                        lng = parseFloat(data[0].lon);
                        latInput.value = lat;
                        lngInput.value = lng;
                        if (searchMarker) map.removeLayer(searchMarker);
                        searchMarker = L.marker([lat, lng]).addTo(map);
                        map.setView([lat, lng], 15);
                    } else {
                        alert("住所が見つかりませんでした。");
                        hideSpinner();
                        return;
                    }
                } catch(error) {
                    console.error("Address Search Error:", error);
                    alert("住所の検索中にエラーが発生しました。");
                    hideSpinner();
                    return;
                }
            } else if (!lat || !lng) {
                 alert("住所を入力するか、地図をクリックしてください。");
                 hideSpinner();
                 return;
            }
            
            await searchFromCoordinates(lat, lng);
        }

        async function searchFromCoordinates(lat, lng) {
            stationMarkers.forEach(m => map.removeLayer(m));
            stationMarkers = [];

            try {
                const limit = document.getElementById('limit-select').value;
                const url = `${lambdaUrl}?lat=${lat}&lng=${lng}&limit=${limit}`;
                const response = await fetch(url);
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                console.error("Fetch Error:", error);
                alert("最寄り駅の検索中にエラーが発生しました。サーバー側のログを確認してください。");
            } finally {
                hideSpinner();
            }
        }
        
        function displayResults(data) {
            resultDiv.innerHTML = ''; 

            if (data.error || !data.response || !data.response.station || data.response.station.length === 0) {
                resultDiv.style.display = 'none';
                alert(data.error || "駅が見つかりませんでした。");
                return;
            }

            const stationsToDisplay = data.response.station;

            const table = document.createElement('table');
            const thead = table.createTHead();
            const tbody = table.createTBody();
            const headerRow = thead.insertRow();
            const headers = ['#', '駅名', '路線', '距離(km)'];
            headers.forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            stationsToDisplay.forEach((s, index) => {
                const rank = index + 1;
                if(s.lat && s.lon) {
                    const numberIcon = L.divIcon({
                        className: 'leaflet-div-icon',
                        html: `<span>${rank}</span>`,
                        iconSize: [28, 28]
                    });
                    const stationMarker = L.marker([s.lat, s.lon], { icon: numberIcon })
                        .addTo(map)
                        .bindPopup(`<b>${rank}. ${s.name}駅</b><br>${s.line || ''}`);
                    stationMarkers.push(stationMarker);
                }
                
                const row = tbody.insertRow();
                const distanceInKm = (parseFloat(s.distance) / 1000).toFixed(2);
                
                row.insertCell().textContent = rank;
                row.insertCell().textContent = s.name;
                row.insertCell().textContent = s.line || '---';
                row.insertCell().textContent = distanceInKm;
            });
            
            resultDiv.appendChild(table);
            resultDiv.style.display = 'block';
        }
    </script>
</body>
</html>